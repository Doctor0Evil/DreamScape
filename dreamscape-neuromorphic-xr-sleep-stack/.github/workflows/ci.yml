name: DreamScape CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  FLYWAY_VERSION: 10.20.0

jobs:
  db-migrations-and-policy:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: dreamscape
          POSTGRES_USER: dreamscape_app
          POSTGRES_PASSWORD: testpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U dreamscape_app -d dreamscape"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - name: Install Flyway CLI
        run: |
          curl -L https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz \
            -o flyway.tar.gz
          tar -xzf flyway.tar.gz
          sudo ln -s "$PWD/flyway-${FLYWAY_VERSION}/flyway" /usr/local/bin/flyway

      - name: Configure Flyway for CI
        run: |
          sed -i 's/dreamscape_app/"dreamscape_app"/g' db/flyway/conf/flyway.conf || true
          sed -i 's/CHANGE_ME_SECURELY/testpassword/g' db/flyway/conf/flyway.conf

      - name: Run Flyway migrations
        run: |
          flyway -configFiles=db/flyway/conf/flyway.conf \
                 -locations=filesystem:db/flyway/sql migrate

      - name: Validate ALN manifests and update git_commit
        run: |
          for manifest in aln/manifests/*.json; do
            jq . "$manifest" > /dev/null
          done
          GIT_COMMIT=$(git rev-parse HEAD)
          sed -i "s/\"git_commit\": \"TO_BE_FILLED_BY_CI_WITH_REAL_COMMIT\"/\"git_commit\": \"${GIT_COMMIT}\"/" aln/manifests/rem_exclusion_manifest_v1_0_0.json || true
          if [ -f aln/manifests/insomnia_manifest_v1_0_0.json ]; then
            sed -i "s/\"git_commit\": \"TO_BE_FILLED_BY_CI_WITH_REAL_COMMIT\"/\"git_commit\": \"${GIT_COMMIT}\"/" aln/manifests/insomnia_manifest_v1_0_0.json || true
          fi

      - name: Insert or verify rem_policy from manifest
        env:
          PGPASSWORD: testpassword
        run: |
          MANIFEST=aln/manifests/rem_exclusion_manifest_v1_0_0.json
          POLICY_ID=$(jq -r '.policy_id' "$MANIFEST")
          LABEL=$(jq -r '.label' "$MANIFEST")
          VERSION=$(jq -r '.version' "$MANIFEST")
          DESC='REM-EXCLUDED-DREAMSCAPE-XR policy synchronized from manifest.'
          QMS_DOC_REF=$(jq -r '.qms_doc_ref' "$MANIFEST")
          psql -h localhost -U dreamscape_app -d dreamscape <<SQL
          INSERT INTO rem_policy (policy_id, label, version, description, rem_excluded, effective_from, created_by, qms_doc_ref)
          VALUES ('${POLICY_ID}', '${LABEL}', '${VERSION}', '${DESC}', TRUE, NOW(), 'ci-pipeline', '${QMS_DOC_REF}')
          ON CONFLICT (policy_id) DO NOTHING;
          SQL

      - name: Schema invariants smoke test
        env:
          PGPASSWORD: testpassword
        run: |
          psql -h localhost -U dreamscape_app -d dreamscape <<'SQL'
          INSERT INTO study (tenant_id, study_code, title, study_type, rem_sleep_allowed, rem_policy_id, irb_protocol_id, created_by)
          VALUES ('11111111-1111-4111-8111-111111111111','TEST_STUDY_001','Pre-sleep relaxation','INSOMNIA_RELAX',FALSE,'99999999-9999-4999-8999-999999999999','IRB-DEMO-001','ci-smoke');
          DO $$
          BEGIN
            BEGIN
              INSERT INTO study (tenant_id, study_code, title, study_type, rem_sleep_allowed, rem_policy_id, irb_protocol_id, created_by)
              VALUES ('11111111-1111-4111-8111-111111111111','TEST_STUDY_REM','REM experiment','REM_EXPERIMENT',TRUE,'99999999-9999-4999-8999-999999999999','IRB-REM','ci-negative');
              RAISE EXCEPTION 'REM study insertion did not fail as expected.';
            EXCEPTION WHEN others THEN
              NULL;
            END;
          END $$;
          SQL

      - name: Run pgTAP DB tests (best-effort)
        env:
          PGPASSWORD: testpassword
        run: |
          # Attempt to create extension, may fail if pgtap isn't available in the container
          psql -h localhost -U dreamscape_app -d dreamscape -c "CREATE EXTENSION IF NOT EXISTS pgtap;" || true
          # Run pgTAP test script; this will fail if extension isn't available
          psql -h localhost -U dreamscape_app -d dreamscape -f db/tests/test_rem_and_calibration.sql || true

  build-go-services:
    runs-on: ubuntu-latest
    needs: db-migrations-and-policy
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      - name: Build policy-service
        working-directory: services/policy-service
        run: |
          go mod tidy
          go build ./cmd
      - name: Build calibration-service
        working-directory: services/calibration-service
        run: |
          go mod tidy
          go build ./cmd
